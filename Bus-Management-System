#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <conio.h>
#include <ctype.h>

#define MAX_USERS 100
#define MAX_TICKETS 100
#define TOTAL_SEATS 36

// ANSI color codes
#define RED "\033[1;31m"
#define BLUE "\033[1;34m"
#define GREEN "\033[1;32m"
#define YELLOW "\033[1;33m"
#define RESET "\033[0m"

// Admin credentials
const char ADMIN_USERNAME[] = "admin";
const char ADMIN_PASSWORD[] = "admin123";

struct User {
    char name[50];
    int age;
    char gender[10];
    char password[50];
};

struct Ticket {
    char from[50];
    char to[50];
    char date[20];
    char time[20];
    int seat;
    float cost;
    char cancelCode[20];
    int userIndex;
};

struct User users[MAX_USERS];
struct Ticket tickets[MAX_TICKETS];
int userCount = 0;
int ticketCount = 0;

const char *VALID_CITIES[] = {
    "Dhaka", "Faridpur", "Gazipur", "Gopalganj", "Kishoreganj", "Madaripur",
    "Manikganj", "Munshiganj", "Narayanganj", "Narsingdi", "Rajbari", "Shariatpur",
    "Tangail", "Bandarban", "Brahmanbaria", "Chandpur", "Chattogram", "Cumilla",
    "Cox's Bazar", "Feni", "Khagrachari", "Lakshmipur", "Noakhali", "Rangamati",
    "Bogura", "Chapai Nawabganj", "Joypurhat", "Naogaon", "Natore", "Pabna",
    "Rajshahi", "Sirajganj", "Bagerhat", "Chuadanga", "Jashore", "Jhenaidah",
    "Khulna", "Kushtia", "Magura", "Meherpur", "Narail", "Satkhira", "Barishal",
    "Barguna", "Bhola", "Jhalokathi", "Patuakhali", "Pirojpur", "Habiganj",
    "Moulvibazar", "Sunamganj", "Sylhet", "Dinajpur", "Gaibandha", "Kurigram",
    "Lalmonirhat", "Nilphamari", "Panchagarh", "Rangpur", "Thakurgaon", "Jamalpur",
    "Mymensingh", "Netrokona", "Sherpur"
};
const int NUM_CITIES = 64;

// Function prototypes
void clearScreen();
void flushInput();
void generateCancelCode(char *code);
void saveUsers();
void loadUsers();
void saveTickets();
void loadTickets();
void mainMenu();
void signupMenu();
void loginMenu();
void userDashboard(int userIndex);
void ticketMenu(int userIndex);
void displayTickets(int userIndex);
void buyTicketMenu(int userIndex);
void cancelTicketMenu(int userIndex);
void trimWhitespace(char *str);
int isValidName(const char *name);
int isValidCity(const char *input, char *correctCity);
int isValidDate(const char *date);
int isValidTime(const char *time);
void displaySeatMap(int takenSeats[]);
void adminLogin();
void adminPanelMenu();
void displayAllUsers();
void displayAllTickets();
void deleteUser();
void deleteTicket();

void clearScreen() {
    system("cls");
}

void flushInput() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

void generateCancelCode(char *code) {
    snprintf(code, 20, "CANCEL-%04d", rand() % 10000);
}

void saveUsers() {
    FILE *file = fopen("users.dat", "wb");
    if (file) {
        fwrite(users, sizeof(struct User), userCount, file);
        fclose(file);
    }
}

void loadUsers() {
    FILE *file = fopen("users.dat", "rb");
    if (file) {
        while (userCount < MAX_USERS &&
              fread(&users[userCount], sizeof(struct User), 1, file)) {
            userCount++;
        }
        fclose(file);
    }
}

void saveTickets() {
    FILE *file = fopen("tickets.dat", "wb");
    if (file) {
        fwrite(tickets, sizeof(struct Ticket), ticketCount, file);
        fclose(file);
    }
}

void loadTickets() {
    FILE *file = fopen("tickets.dat", "rb");
    if (file) {
        while (ticketCount < MAX_TICKETS &&
              fread(&tickets[ticketCount], sizeof(struct Ticket), 1, file)) {
            ticketCount++;
        }
        fclose(file);
    }
}

void trimWhitespace(char *str) {
    if (str == NULL || *str == '\0') return;

    char *end;
    while(isspace((unsigned char)*str)) str++;

    end = str + strlen(str) - 1;
    while(end > str && isspace((unsigned char)*end)) end--;

    *(end+1) = '\0';
}

int isValidName(const char *name) {
    if(strlen(name) == 0) return 0;

    int hasLetters = 0;
    for(int i = 0; name[i]; i++) {
        if(isalpha(name[i])) {
            hasLetters = 1;
        }
        else if(name[i] != ' ') {
            return 0;
        }
    }
    return hasLetters;
}

int isValidCity(const char *input, char *correctCity) {
    char inputLower[50];
    strcpy(inputLower, input);
    for(int i = 0; inputLower[i]; i++) {
        inputLower[i] = tolower(inputLower[i]);
    }

    for(int i = 0; i < NUM_CITIES; i++) {
        char cityLower[50];
        strcpy(cityLower, VALID_CITIES[i]);
        for(int j = 0; cityLower[j]; j++) {
            cityLower[j] = tolower(cityLower[j]);
        }

        if(strcmp(inputLower, cityLower) == 0) {
            strcpy(correctCity, VALID_CITIES[i]);
            return 1;
        }
    }
    return 0;
}

int isValidDate(const char *date) {
    int d, m, y;
    if(sscanf(date, "%d/%d/%d", &d, &m, &y) != 3) return 0;

    if(y < 2025 || y > 2030) return 0;
    if(m < 1 || m > 12) return 0;
    if(d < 1 || d > 31) return 0;

    if((m == 4 || m == 6 || m == 9 || m == 11) && d > 30) return 0;
    if(m == 2) {
        if(d > 29) return 0;
        if(d == 29 && !(y % 4 == 0 && (y % 100 != 0 || y % 400 == 0))) return 0;
    }
    return 1;
}

int isValidTime(const char *time) {
    int h, m;
    if(sscanf(time, "%d:%d", &h, &m) != 2) return 0;
    if(h < 0 || h > 23) return 0;
    if(m < 0 || m > 59) return 0;
    return 1;
}

void displaySeatMap(int takenSeats[]) {
    printf("\n=== Seat Map ===\n");
    for(int i = 0; i < TOTAL_SEATS; i++) {
        if(takenSeats[i]) {
            printf(GREEN "[XX]" RESET);
        } else {
            printf("[%02d]", i + 1);
        }

        if((i + 1) % 4 == 0)
            printf("\n");
        else if((i + 1) % 2 == 0)
            printf("    ");
        else
            printf(" ");
    }
    printf("\n\n");
}

void mainMenu() {
    clearScreen();
    printf("=== BUS TICKET SYSTEM ===\n");
    printf("1. Signup\n");
    printf("2. Login\n");
    printf("3. Exit\n");
    printf("4. Admin Login\n");
    printf("Choose: ");

    int choice;
    scanf("%d", &choice);
    flushInput();

    switch(choice) {
        case 1: signupMenu(); break;
        case 2: loginMenu(); break;
        case 3: exit(0);
        case 4: adminLogin(); break;
        default:
            printf(RED "Invalid choice! " RESET "Press any key to continue...");
            getch();
            mainMenu();
    }
}

void signupMenu() {
    clearScreen();
    printf("=== SIGNUP ===\n");

    if(userCount >= MAX_USERS) {
        printf(RED "User limit reached!\n" RESET);
        printf("Press any key to return...");
        getch();
        mainMenu();
        return;
    }

    struct User newUser;

    int validName = 0;
    do {
        printf("Enter name: ");
        fgets(newUser.name, 50, stdin);
        newUser.name[strcspn(newUser.name, "\n")] = '\0';
        trimWhitespace(newUser.name);

        int exists = 0;
        for(int i = 0; i < userCount; i++) {
            if(strcasecmp(users[i].name, newUser.name) == 0) {
                exists = 1;
                break;
            }
        }

        if(exists) {
            printf(RED "Username already exists! Please choose a different name.\n" RESET);
            continue;
        }

        if(isValidName(newUser.name)) {
            validName = 1;
        } else {
            printf(RED "Invalid name! Only letters and spaces are allowed.\n" RESET);
        }
    } while(!validName);

    char ageInput[10];
    int validAge = 0;
    do {
        printf("Enter age (18-100): ");
        fgets(ageInput, sizeof(ageInput), stdin);
        if(sscanf(ageInput, "%d", &newUser.age) == 1) {
            if(newUser.age >= 18 && newUser.age <= 100) {
                validAge = 1;
            } else {
                printf(RED "Age must be between 18 and 100!\n" RESET);
            }
        } else {
            printf(RED "Invalid age. Please enter a valid number between 18-100.\n" RESET);
        }
    } while(!validAge);

    char tempGender[20];
    int validGender = 0;
    do {
        printf("Enter gender (male/female/other): ");
        fgets(tempGender, sizeof(tempGender), stdin);
        tempGender[strcspn(tempGender, "\n")] = '\0';

        for(int i = 0; tempGender[i]; i++) {
            tempGender[i] = tolower(tempGender[i]);
        }

        if(strcmp(tempGender, "male") == 0 ||
           strcmp(tempGender, "female") == 0 ||
           strcmp(tempGender, "other") == 0) {
            strncpy(newUser.gender, tempGender, sizeof(newUser.gender) - 1);
            newUser.gender[sizeof(newUser.gender) - 1] = '\0';
            validGender = 1;
        } else {
            printf(RED "Invalid gender. Please enter male, female, or other.\n" RESET);
        }
    } while(!validGender);

    printf("Enter password: ");
    fgets(newUser.password, 50, stdin);
    newUser.password[strcspn(newUser.password, "\n")] = '\0';

    users[userCount++] = newUser;
    saveUsers();

    printf(BLUE "\nSignup successful!" RESET "\n\nPress any key to continue...");
    getch();
    mainMenu();
}

void loginMenu() {
    clearScreen();
    printf("=== LOGIN ===\n");

    char name[50], password[50];
    int i = 0;
    char ch;

    printf("Enter name: ");
    fgets(name, 50, stdin);
    name[strcspn(name, "\n")] = '\0';

    printf("Enter password: ");

    while(1) {
        ch = getch();
        if(ch == 13) {
            password[i] = '\0';
            break;
        }
        else if(ch == 8) {
            if(i > 0) {
                i--;
                printf("\b \b");
            }
        }
        else if(i < 49) {
            password[i] = ch;
            i++;
            printf("*");
        }
    }
    password[i] = '\0';

    for(int i = 0; i < userCount; i++) {
        if(strcmp(users[i].name, name) == 0 && strcmp(users[i].password, password) == 0) {
            printf(BLUE "\nLogin successful!" RESET " Press any key to continue...");
            getch();
            userDashboard(i);
            return;
        }
    }

    printf(RED "\nInvalid credentials!" RESET " Press any key to retry...");
    getch();
    mainMenu();
}

void userDashboard(int userIndex) {
    clearScreen();
    printf("=== USER DASHBOARD ===\n");
    printf("Logged in as: %s\n\n", users[userIndex].name);
    printf("1. Ticket Management\n");
    printf("2. Logout\n");
    printf("Choose: ");

    int choice;
    scanf("%d", &choice);
    flushInput();

    switch(choice) {
        case 1: ticketMenu(userIndex); break;
        case 2: mainMenu(); break;
        default:
            printf(RED "Invalid choice! " RESET "Press any key to continue...");
            getch();
            userDashboard(userIndex);
    }
}

void ticketMenu(int userIndex) {
    clearScreen();
    printf("=== TICKET MANAGEMENT ===\n");
    printf("1. View Tickets\n");
    printf("2. Buy Ticket\n");
    printf("3. Cancel Ticket\n");
    printf("4. Back to Dashboard\n");
    printf("Choose: ");

    int choice;
    scanf("%d", &choice);
    flushInput();

    switch(choice) {
        case 1: displayTickets(userIndex); break;
        case 2: buyTicketMenu(userIndex); break;
        case 3: cancelTicketMenu(userIndex); break;
        case 4: userDashboard(userIndex); break;
        default:
            printf(RED "Invalid choice! " RESET "Press any key to continue...");
            getch();
            ticketMenu(userIndex);
    }
}

void displayTickets(int userIndex) {
    clearScreen();
    printf("=== YOUR TICKETS ===\n");

    int found = 0;
    for(int i = 0; i < ticketCount; i++) {
        if(tickets[i].userIndex == userIndex) {
            printf("From: %s\n", tickets[i].from);
            printf("To: %s\n", tickets[i].to);
            printf("Date: %s\tTime: %s\n", tickets[i].date, tickets[i].time);
            printf("Seat: %d\tCost: Tk%.2f\n", tickets[i].seat, tickets[i].cost);
            printf("Cancellation Code: %s\n\n", tickets[i].cancelCode);
            found = 1;
        }
    }

    if(!found) printf(RED "No tickets found!\n" RESET);
    printf("\nPress any key to return...");
    getch();
    ticketMenu(userIndex);
}

void buyTicketMenu(int userIndex) {
    clearScreen();
    printf("=== BUY TICKET ===\n");

    if(ticketCount >= MAX_TICKETS) {
        printf(RED "Ticket limit reached!\n" RESET);
        printf("Press any key to return...");
        getch();
        ticketMenu(userIndex);
        return;
    }

    struct Ticket newTicket;
    char buffer[50];
    char correctCity[50];
    int takenSeats[TOTAL_SEATS] = {0};

    do {
        printf("Enter departure city: ");
        fgets(buffer, 50, stdin);
        buffer[strcspn(buffer, "\n")] = '\0';
        trimWhitespace(buffer);

        if(isValidCity(buffer, correctCity)) {
            strcpy(newTicket.from, correctCity);
            break;
        }
        printf(RED "Invalid city! Please enter a valid district of Bangladesh.\n" RESET);
    } while(1);

    do {
        printf("Enter destination city: ");
        fgets(buffer, 50, stdin);
        buffer[strcspn(buffer, "\n")] = '\0';
        trimWhitespace(buffer);

        if(isValidCity(buffer, correctCity)) {
            strcpy(newTicket.to, correctCity);
            if(strcmp(newTicket.from, newTicket.to) == 0) {
                printf(RED "Destination cannot be same as departure!\n" RESET);
                continue;
            }
            break;
        }
        printf(RED "Invalid city! Please enter a valid district of Bangladesh.\n" RESET);
    } while(1);

    do {
        printf("Enter travel date (DD/MM/YYYY): ");
        fgets(buffer, 20, stdin);
        buffer[strcspn(buffer, "\n")] = '\0';
        trimWhitespace(buffer);

        if(isValidDate(buffer)) {
            strcpy(newTicket.date, buffer);
            break;
        }
        printf(RED "Invalid date! Use DD/MM/YYYY format with valid date (2025-2030).\n" RESET);
    } while(1);

    do {
        printf("Enter departure time (HH:MM): ");
        fgets(buffer, 20, stdin);
        buffer[strcspn(buffer, "\n")] = '\0';
        trimWhitespace(buffer);

        if(isValidTime(buffer)) {
            strcpy(newTicket.time, buffer);
            break;
        }
        printf(RED "Invalid time! Use HH:MM 24-hour format.\n" RESET);
    } while(1);

    for(int i = 0; i < ticketCount; i++) {
        if(strcmp(tickets[i].from, newTicket.from) == 0 &&
           strcmp(tickets[i].to, newTicket.to) == 0 &&
           strcmp(tickets[i].date, newTicket.date) == 0 &&
           strcmp(tickets[i].time, newTicket.time) == 0) {
            if(tickets[i].seat >= 1 && tickets[i].seat <= TOTAL_SEATS) {
                takenSeats[tickets[i].seat - 1] = 1;
            }
        }
    }

    displaySeatMap(takenSeats);

    int seatValid = 0;
    do {
        printf("Choose seat (1-%d): ", TOTAL_SEATS);
        if(scanf("%d", &newTicket.seat) != 1) {
            flushInput();
            printf(RED "Invalid input. " RESET);
            continue;
        }
        flushInput();

        if(newTicket.seat < 1 || newTicket.seat > TOTAL_SEATS) {
            printf(RED "Seat number out of range. " RESET);
        } else if(takenSeats[newTicket.seat - 1]) {
            printf(RED "Seat already occupied. " RESET);
        } else {
            seatValid = 1;
        }
    } while(!seatValid);

    newTicket.cost = 1000.0;

    clearScreen();
    printf("=== TICKET SUMMARY ===\n");
    printf("From: %s\n", newTicket.from);
    printf("To: %s\n", newTicket.to);
    printf("Date: %s\n", newTicket.date);
    printf("Time: %s\n", newTicket.time);
    printf("Seat: %d\n", newTicket.seat);
    printf("Total Cost: %.2f TK\n", newTicket.cost);

    printf("\nConfirm purchase (Y/N)? ");
    char choice = getchar();
    flushInput();

    if(toupper(choice) == 'Y') {
        generateCancelCode(newTicket.cancelCode);
        newTicket.userIndex = userIndex;
        tickets[ticketCount++] = newTicket;
        saveTickets();
        printf(BLUE "\nPurchase successful!     Cancellation code: %s" RESET, newTicket.cancelCode);
    } else {
        printf(RED "\nPurchase cancelled." RESET);
    }

    printf("\nPress any key to continue...");
    getch();
    ticketMenu(userIndex);
}

void cancelTicketMenu(int userIndex) {
    clearScreen();
    printf("=== CANCEL TICKET ===\n");

    char code[20];
    printf("Enter cancellation code (enter 0 to return to menu): ");
    fgets(code, 20, stdin);
    code[strcspn(code, "\n")] = '\0';

    if(strcmp(code, "0") == 0) {
        ticketMenu(userIndex);
        return;
    }

    for(int i = 0; i < ticketCount; i++) {
        if(strcmp(tickets[i].cancelCode, code) == 0 && tickets[i].userIndex == userIndex) {
            for(int j = i; j < ticketCount - 1; j++) {
                tickets[j] = tickets[j + 1];
            }
            ticketCount--;
            saveTickets();
            printf(BLUE "\nTicket cancelled successfully!" RESET);
            printf("\nPress any key to continue...");
            getch();
            ticketMenu(userIndex);
            return;
        }
    }

    printf(RED "\nInvalid cancellation code or unauthorized access!" RESET);
    printf("\nPress any key to try again...");
    getch();
    cancelTicketMenu(userIndex);
}

void adminLogin() {
    clearScreen();
    printf("=== ADMIN LOGIN ===\n");
    char username[50], password[50];
    int i = 0;
    char ch;

    printf("Username: ");
    fgets(username, 50, stdin);
    username[strcspn(username, "\n")] = '\0';

    printf("Password: ");

    while(1) {
        ch = getch();
        if(ch == 13) {
            password[i] = '\0';
            break;
        }
        else if(ch == 8) {
            if(i > 0) {
                i--;
                printf("\b \b");
            }
        }
        else if(i < 49) {
            password[i] = ch;
            i++;
            printf("*");
        }
    }
    password[i] = '\0';

    if(strcmp(username, ADMIN_USERNAME) == 0 && strcmp(password, ADMIN_PASSWORD) == 0) {
        printf(GREEN "\nLogin successful!" RESET);
        getch();
        adminPanelMenu();
    } else {
        printf(RED "\nInvalid admin credentials!" RESET);
        getch();
        mainMenu();
    }
}

void adminPanelMenu() {
    clearScreen();
    printf("=== ADMIN PANEL ===\n");
    printf("1. View All Users\n");
    printf("2. View All Tickets\n");
    printf("3. Delete User\n");
    printf("4. Delete Ticket\n");
    printf("5. Logout\n");
    printf("Choose: ");

    int choice;
    scanf("%d", &choice);
    flushInput();

    switch(choice) {
        case 1: displayAllUsers(); break;
        case 2: displayAllTickets(); break;
        case 3: deleteUser(); break;
        case 4: deleteTicket(); break;
        case 5: mainMenu(); break;
        default:
            printf(RED "Invalid choice!" RESET);
            getch();
            adminPanelMenu();
    }
}

void displayAllUsers() {
    clearScreen();
    printf("=== ALL REGISTERED USERS ===\n");
    if(userCount == 0) {
        printf(RED "No users found!\n" RESET);
    } else {
        for(int i = 0; i < userCount; i++) {
            printf("User #%d\n", i+1);
            printf("Name: %s\n", users[i].name);
            printf("Age: %d\n", users[i].age);
            printf("Gender: %s\n", users[i].gender);
            printf("----------------------------\n");
        }
    }
    printf("\nPress any key to return...");
    getch();
    adminPanelMenu();
}

void displayAllTickets() {
    clearScreen();
    printf("=== ALL BOOKED TICKETS ===\n");
    if(ticketCount == 0) {
        printf(RED "No tickets found!\n" RESET);
    } else {
        for(int i = 0; i < ticketCount; i++) {
            printf("Ticket #%d\n", i+1);
            printf("From: %s\n", tickets[i].from);
            printf("To: %s\n", tickets[i].to);
            printf("Date: %s\n", tickets[i].date);
            printf("Time: %s\n", tickets[i].time);
            printf("Seat: %d\n", tickets[i].seat);
            printf("Cost: %.2f TK\n", tickets[i].cost);
            printf("User: %s\n", (tickets[i].userIndex < userCount) ?
                   users[tickets[i].userIndex].name : "[Deleted User]");
            printf("Cancellation Code: %s\n", tickets[i].cancelCode);
            printf("----------------------------\n");
        }
    }
    printf("\nPress any key to return...");
    getch();
    adminPanelMenu();
}

void deleteUser() {
    clearScreen();
    printf("=== DELETE USER ===\n");

    if(userCount == 0) {
        printf(RED "No users to delete!\n" RESET);
        getch();
        adminPanelMenu();
        return;
    }

    printf("List of Users:\n");
    for(int i = 0; i < userCount; i++) {
        printf("%d. %s (Age: %d, Gender: %s)\n",
              i+1, users[i].name, users[i].age, users[i].gender);
    }

    printf("\nEnter user number to delete (0 to cancel): ");
    int userNum;
    scanf("%d", &userNum);
    flushInput();

    if(userNum == 0) {
        adminPanelMenu();
        return;
    }

    int deleteIndex = userNum - 1;
    if(deleteIndex < 0 || deleteIndex >= userCount) {
        printf(RED "Invalid user number!\n" RESET);
        getch();
        deleteUser();
        return;
    }

    // Remove user
    for(int i = deleteIndex; i < userCount-1; i++) {
        users[i] = users[i+1];
    }
    userCount--;

    // Update tickets
    int t = 0;
    while(t < ticketCount) {
        if(tickets[t].userIndex == deleteIndex) {
            // Remove ticket
            for(int j = t; j < ticketCount-1; j++) {
                tickets[j] = tickets[j+1];
            }
            ticketCount--;
        }
        else if(tickets[t].userIndex > deleteIndex) {
            tickets[t].userIndex--;
            t++;
        }
        else {
            t++;
        }
    }

    saveUsers();
    saveTickets();

    printf(GREEN "\nUser and associated tickets deleted successfully!\n" RESET);
    getch();
    adminPanelMenu();
}

void deleteTicket() {
    clearScreen();
    printf("=== DELETE TICKET ===\n");

    if(ticketCount == 0) {
        printf(RED "No tickets to delete!\n" RESET);
        getch();
        adminPanelMenu();
        return;
    }

    printf("List of Tickets:\n");
    for(int i = 0; i < ticketCount; i++) {
        printf("%d. From: %s to %s (Seat: %d, User: %s)\n",
              i+1, tickets[i].from, tickets[i].to, tickets[i].seat,
              (tickets[i].userIndex < userCount) ?
              users[tickets[i].userIndex].name : "[Deleted User]");
    }

    printf("\nEnter ticket number to delete (0 to cancel): ");
    int ticketNum;
    scanf("%d", &ticketNum);
    flushInput();

    if(ticketNum == 0) {
        adminPanelMenu();
        return;
    }

    int deleteIndex = ticketNum - 1;
    if(deleteIndex < 0 || deleteIndex >= ticketCount) {
        printf(RED "Invalid ticket number!\n" RESET);
        getch();
        deleteTicket();
        return;
    }

    // Remove ticket
    for(int i = deleteIndex; i < ticketCount-1; i++) {
        tickets[i] = tickets[i+1];
    }
    ticketCount--;

    saveTickets();

    printf(GREEN "\nTicket deleted successfully!\n" RESET);
    getch();
    adminPanelMenu();
}

int main() {
    srand(time(0));
    loadUsers();
    loadTickets();
    mainMenu();
    return 0;
}
